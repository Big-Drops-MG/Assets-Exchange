const MALWARE_SCAN_PATH = "/upload_document";
const SCAN_TIMEOUT_MS = 60_000;

export type MalwareScanResult =
  | { status: "clean"; info?: string }
  | { status: "infected"; info: string }
  | { status: "error"; info: string };

function filenameFromUrl(fileUrl: string): string {
  try {
    const pathname = new URL(fileUrl).pathname;
    const segment = pathname.split("/").filter(Boolean).pop();
    if (segment) return decodeURIComponent(segment);
  } catch {
    // ignore
  }
  return "upload";
}

export async function scanFileByUrl(
  fileUrl: string,
  baseUrl?: string
): Promise<MalwareScanResult> {
  const url = baseUrl ?? process.env.PYTHON_SERVICE_URL;
  if (!url) {
    return { status: "error", info: "Malware scan service not configured" };
  }

  const scanUrl = url.replace(/\/$/, "") + MALWARE_SCAN_PATH;
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), SCAN_TIMEOUT_MS);

  try {
    const fileRes = await fetch(fileUrl, { signal: controller.signal });
    if (!fileRes.ok) {
      return {
        status: "error",
        info: `Failed to fetch file: ${fileRes.status}`,
      };
    }
    const buffer = Buffer.from(await fileRes.arrayBuffer());
    const filename = filenameFromUrl(fileUrl);
    const form = new FormData();
    form.append("file", new Blob([buffer]), filename);

    const res = await fetch(scanUrl, {
      method: "POST",
      body: form,
      signal: controller.signal,
    });
    clearTimeout(timeout);

    let data: { status?: string; info?: string };
    try {
      const text = await res.text();
      data = text
        ? (JSON.parse(text) as { status?: string; info?: string })
        : {};
    } catch {
      return {
        status: "error",
        info: res.ok ? "Invalid scan response" : `Scan failed (${res.status})`,
      };
    }
    const status = data?.status;
    if (status === "clean") {
      return { status: "clean", info: data.info };
    }
    if (status === "infected") {
      return { status: "infected", info: data.info ?? "Malware detected" };
    }
    const errorInfo = data?.info ?? `Scan failed (${res.status})`;
    const isScannerUnavailable =
      /scanner unavailable|empty scan result|connection refused|try again/i.test(
        errorInfo
      );
    if (isScannerUnavailable) {
      await new Promise((r) => setTimeout(r, 3000));
      const retryForm = new FormData();
      retryForm.append("file", new Blob([buffer]), filename);
      const retry = await doScanRequest(scanUrl, retryForm, controller.signal);
      if (retry) return retry;
    }
    return { status: "error", info: errorInfo };
  } catch (e) {
    clearTimeout(timeout);
    const message = e instanceof Error ? e.message : String(e);
    return { status: "error", info: message };
  }
}

async function doScanRequest(
  scanUrl: string,
  form: FormData,
  signal: AbortSignal
): Promise<MalwareScanResult | null> {
  try {
    const res = await fetch(scanUrl, { method: "POST", body: form, signal });
    const text = await res.text();
    const data = text
      ? (JSON.parse(text) as { status?: string; info?: string })
      : {};
    const status = data?.status;
    if (status === "clean") return { status: "clean", info: data.info };
    if (status === "infected")
      return { status: "infected", info: data.info ?? "Malware detected" };
    return null;
  } catch {
    return null;
  }
}

export function isMalwareScanEnabled(): boolean {
  return Boolean(process.env.PYTHON_SERVICE_URL);
}
